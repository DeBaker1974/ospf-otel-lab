#!/bin/bash

# ============================================
# OSPF OTEL Lab - Comprehensive Status Dashboard
# Version: v15.1 - Fixed LLDP/SNMP Detection
# ============================================

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Helper functions
print_header() {
    echo ""
    echo -e "${BLUE}${BOLD}=========================================${NC}"
    echo -e "${BLUE}${BOLD}$1${NC}"
    echo -e "${BLUE}${BOLD}=========================================${NC}"
    echo ""
}

print_section() {
    echo -e "${CYAN}${BOLD}━━━ $1 ━━━${NC}"
}

print_status() {
    local status=$1
    local message=$2
    case $status in
        ok)
            echo -e "  ${GREEN}✓${NC} $message"
            ;;
        warning)
            echo -e "  ${YELLOW}⚠${NC} $message"
            ;;
        error)
            echo -e "  ${RED}✗${NC} $message"
            ;;
        info)
            echo -e "  ${BLUE}ℹ${NC} $message"
            ;;
    esac
}

# Load environment
LAB_DIR="$HOME/ospf-otel-lab"
ENV_FILE="$LAB_DIR/.env"
if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE"
fi

clear
print_header "OSPF OTEL Lab - Status Dashboard v15.1"
echo -e "${CYAN}Complete Network Observability Stack${NC}"
echo -e "${CYAN}SNMP • Syslog • LLDP • NetFlow (Logstash) • Backups${NC}"

# ============================================
# INFRASTRUCTURE STATUS
# ============================================
print_section "Infrastructure"

RUNNING=$(docker ps --filter "name=clab-ospf-network" --filter "status=running" -q | wc -l)
TOTAL=$(docker ps -a --filter "name=clab-ospf-network" -q | wc -l)

echo -e "  ${BOLD}Containers:${NC} $RUNNING/$TOTAL running"
if [ $RUNNING -eq $TOTAL ] && [ $TOTAL -eq 14 ]; then
    print_status ok "All containers operational"
else
    print_status warning "Some containers stopped (Expected: 14 with Logstash)"
    echo ""
    echo "  Stopped containers:"
    docker ps -a --filter "name=clab-ospf-network" --filter "status=exited" --format "    - {{.Names}}" | head -5
fi

echo ""
echo -e "  ${BOLD}Disk Usage:${NC}"
LAB_SIZE=$(du -sh "$LAB_DIR" 2>/dev/null | cut -f1)
BACKUP_SIZE=$(du -sh "$LAB_DIR/backups" 2>/dev/null | cut -f1 || echo "0")
echo "    Lab directory: $LAB_SIZE"
echo "    Backups: $BACKUP_SIZE"

# ============================================
# ROUTING PROTOCOLS
# ============================================
print_section "Routing Protocols"

echo -e "  ${BOLD}OSPF:${NC}"
OSPF_FULL=$(docker exec clab-ospf-network-csr28 vtysh -c "show ip ospf neighbor" 2>/dev/null | grep -c "Full" || echo 0)
OSPF_TOTAL=$(docker exec clab-ospf-network-csr28 vtysh -c "show ip ospf neighbor" 2>/dev/null | grep -c "/" || echo 0)
echo "    Neighbors: $OSPF_FULL Full / $OSPF_TOTAL Total"

if [ "$OSPF_FULL" -ge 2 ]; then
    print_status ok "OSPF converged"
    AREA=$(docker exec clab-ospf-network-csr28 vtysh -c "show ip ospf" 2>/dev/null | grep "Area ID" | awk '{print $3}' | head -1)
    echo "    Area: ${AREA:-0.0.0.0}"
else
    print_status warning "OSPF not fully converged"
fi

echo ""
echo -e "  ${BOLD}VRRP:${NC}"
if docker exec clab-ospf-network-csr25 vtysh -c "show vrrp" 2>/dev/null | grep -q "Master"; then
    VRRP_MASTER="CSR25"
    VRRP_BACKUP="CSR26"
else
    VRRP_MASTER="CSR26"
    VRRP_BACKUP="CSR25"
fi
echo "    Master: $VRRP_MASTER"
echo "    Backup: $VRRP_BACKUP"
echo "    VIP: 192.168.10.1"
print_status ok "VRRP operational"

# ============================================
# Get Elasticsearch Data First (for smart detection)
# ============================================
if [ -n "$ES_ENDPOINT" ] && [ -n "$ES_API_KEY" ]; then
    SNMP_COUNT=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/metrics-snmp.metrics-prod/_count" 2>/dev/null | jq -r '.count // 0')
    SNMP_RECENT=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/metrics-snmp.metrics-prod/_count" -H 'Content-Type: application/json' -d '{"query":{"range":{"@timestamp":{"gte":"now-1m"}}}}' 2>/dev/null | jq -r '.count // 0')
    
    LOGS_COUNT=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/logs-frr.log-default/_count" 2>/dev/null | jq -r '.count // 0')
    LOGS_RECENT=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/logs-frr.log-default/_count" -H 'Content-Type: application/json' -d '{"query":{"range":{"@timestamp":{"gte":"now-1m"}}}}' 2>/dev/null | jq -r '.count // 0')
    
    LLDP_COUNT=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/lldp-topology/_count" 2>/dev/null | jq -r '.count // 0')
    LLDP_RECENT=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/lldp-topology/_count" -H 'Content-Type: application/json' -d '{"query":{"range":{"@timestamp":{"gte":"now-1m"}}}}' 2>/dev/null | jq -r '.count // 0')
    
    NETFLOW_COUNT=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/logs-netflow-default/_count" 2>/dev/null | jq -r '.count // 0')
    NETFLOW_RECENT=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/logs-netflow-default/_count" -H 'Content-Type: application/json' -d '{"query":{"range":{"@timestamp":{"gte":"now-1m"}}}}' 2>/dev/null | jq -r '.count // 0')
else
    SNMP_COUNT=0
    SNMP_RECENT=0
    LOGS_COUNT=0
    LOGS_RECENT=0
    LLDP_COUNT=0
    LLDP_RECENT=0
    NETFLOW_COUNT=0
    NETFLOW_RECENT=0
fi

# ============================================
# TOPOLOGY DISCOVERY (Smart Detection)
# ============================================
print_section "Topology Discovery"

echo -e "  ${BOLD}LLDP:${NC}"

# Check if LLDP data is in Elasticsearch (primary indicator)
if [ "$LLDP_COUNT" -gt 0 ]; then
    echo "    Data in Elasticsearch: ${LLDP_COUNT} documents"
    echo "    Recent activity (1m): ${LLDP_RECENT} documents"
    
    # Get unique neighbors count
    LLDP_NEIGHBORS=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/lldp-topology/_search?size=0" -H 'Content-Type: application/json' -d '{"aggs":{"unique_links":{"cardinality":{"field":"neighbor_sysname.keyword"}}}}' 2>/dev/null | jq -r '.aggregations.unique_links.value // 0')
    echo "    Unique neighbors: $LLDP_NEIGHBORS"
    
    print_status ok "LLDP data flowing to Elasticsearch"
    
    # Check collection service
    if systemctl is-active --quiet lldp-topology-collector 2>/dev/null; then
        echo "    Collection service: Running"
    else
        echo "    Collection service: Not detected (but data is flowing)"
    fi
else
    # No data in ES, check daemons
    LLDP_RUNNING=0
    for router in csr23 csr24 csr25 csr26 csr27 csr28 csr29; do
        if docker exec clab-ospf-network-$router pgrep lldpd >/dev/null 2>&1; then
            LLDP_RUNNING=$((LLDP_RUNNING + 1))
        fi
    done
    
    echo "    Daemons: $LLDP_RUNNING/7 running"
    echo "    Data in Elasticsearch: None"
    
    print_status warning "No LLDP data in Elasticsearch"
    echo "      Setup: ./scripts/setup-lldp-topology-collector.sh"
fi

# ============================================
# DATA COLLECTION (Smart Detection)
# ============================================
print_section "Data Collection"

echo -e "  ${BOLD}SNMP:${NC}"

if [ "$SNMP_COUNT" -gt 0 ]; then
    echo "    Data in Elasticsearch: ${SNMP_COUNT} documents"
    echo "    Recent activity (1m): ${SNMP_RECENT} documents"
    
    # Get metric types
    METRIC_TYPES=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/metrics-snmp.metrics-prod/_search?size=0" -H 'Content-Type: application/json' -d '{"aggs":{"types":{"cardinality":{"field":"metric.name.keyword"}}}}' 2>/dev/null | jq -r '.aggregations.types.value // 0')
    echo "    Metric types: $METRIC_TYPES"
    
    # Get active hosts
    ACTIVE_HOSTS=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/metrics-snmp.metrics-prod/_search?size=0" -H 'Content-Type: application/json' -d '{"query":{"range":{"@timestamp":{"gte":"now-5m"}}},"aggs":{"hosts":{"cardinality":{"field":"host.name.keyword"}}}}' 2>/dev/null | jq -r '.aggregations.hosts.value // 0')
    echo "    Active hosts (5m): $ACTIVE_HOSTS/7"
    
    if [ "$SNMP_RECENT" -gt 0 ]; then
        print_status ok "SNMP data actively flowing"
    else
        print_status warning "SNMP data exists but not recent"
        echo "      Check: docker restart clab-ospf-network-otel-collector"
    fi
else
    # Fallback to process check
    SNMP_RUNNING=0
    for router in csr23 csr24 csr25 csr26 csr27 csr28 csr29; do
        if docker exec clab-ospf-network-$router pgrep snmpd >/dev/null 2>&1; then
            SNMP_RUNNING=$((SNMP_RUNNING + 1))
        fi
    done
    echo "    Agents: $SNMP_RUNNING/7 running"
    echo "    Data in Elasticsearch: None"
    
    print_status warning "No SNMP data in Elasticsearch"
    echo "      Fix: ./scripts/install-snmp-lldp.sh"
fi

echo ""
echo -e "  ${BOLD}Syslog:${NC}"

OTEL_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' clab-ospf-network-otel-collector 2>/dev/null)

if [ "$LOGS_COUNT" -gt 0 ]; then
    echo "    Data in Elasticsearch: ${LOGS_COUNT} documents"
    echo "    Recent activity (1m): ${LOGS_RECENT} documents"
    echo "    Target: $OTEL_IP:5140"
    
    if [ "$LOGS_RECENT" -gt 0 ]; then
        print_status ok "Syslog data actively flowing"
    else
        print_status warning "Syslog data exists but not recent"
    fi
else
    RSYSLOG_RUNNING=0
    for router in csr23 csr24 csr25 csr26 csr27 csr28 csr29; do
        if docker exec clab-ospf-network-$router pgrep rsyslogd >/dev/null 2>&1; then
            RSYSLOG_RUNNING=$((RSYSLOG_RUNNING + 1))
        fi
    done
    echo "    Agents: $RSYSLOG_RUNNING/7 running"
    echo "    Target: $OTEL_IP:5140"
    echo "    Data in Elasticsearch: None"
    
    print_status warning "No syslog data in Elasticsearch"
    echo "      Fix: ./scripts/fix-syslog-complete.sh"
fi

echo ""
echo -e "  ${BOLD}NetFlow:${NC}"

LOGSTASH_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' clab-ospf-network-logstash 2>/dev/null)

SOFTFLOWD_RUNNING=0
for router in csr23 csr24 csr25 csr26 csr27 csr28 csr29; do
    PROCESSES=$(docker exec clab-ospf-network-$router pgrep -c softflowd 2>/dev/null || echo 0)
    if [ "$PROCESSES" -gt 0 ]; then
        SOFTFLOWD_RUNNING=$((SOFTFLOWD_RUNNING + 1))
    fi
done

if [ "$NETFLOW_COUNT" -gt 0 ]; then
    echo "    Data in Elasticsearch: ${NETFLOW_COUNT} documents"
    echo "    Recent activity (1m): ${NETFLOW_RECENT} documents"
    echo "    Collector: Logstash ($LOGSTASH_IP:2055)"
    
    if [ "$NETFLOW_RECENT" -gt 0 ]; then
        print_status ok "NetFlow data actively flowing"
    else
        print_status warning "NetFlow data exists but not recent"
        echo "      Generate traffic: ./scripts/generate-traffic.sh"
    fi
else
    echo "    Exporters: $SOFTFLOWD_RUNNING/7 routers"
    echo "    Collector: Logstash ($LOGSTASH_IP:2055)"
    echo "    Data in Elasticsearch: None"
    
    if [ "$SOFTFLOWD_RUNNING" -gt 0 ]; then
        print_status warning "NetFlow configured but no data"
        echo "      Generate traffic: ./scripts/generate-traffic.sh"
    else
        print_status info "NetFlow not configured"
        echo "      Setup: ./scripts/setup-netflow.sh"
    fi
fi

# ============================================
# LOGSTASH
# ============================================
print_section "Logstash NetFlow Collector"

LOGSTASH_STATUS=$(docker inspect clab-ospf-network-logstash --format='{{.State.Status}}' 2>/dev/null)
echo -e "  ${BOLD}Status:${NC} ${LOGSTASH_STATUS:-Not deployed}"

if [ "$LOGSTASH_STATUS" = "running" ]; then
    print_status ok "Logstash operational"
    echo "  IP Address: $LOGSTASH_IP"
    
    # Check pipeline with better error handling
    PIPELINE_CHECK=$(docker logs --tail 50 clab-ospf-network-logstash 2>&1 | grep -c "Pipeline started" || echo "0")
    if [ "$PIPELINE_CHECK" -gt 0 ]; then
        echo "  Pipeline: Loaded and running"
        print_status ok "NetFlow pipeline active"
    else
        print_status warning "Pipeline not started yet (may still be loading)"
    fi
    
    # Check for errors
    ERRORS=$(docker logs --tail 100 clab-ospf-network-logstash 2>&1 | grep -ic "error" || echo "0")
    if [ "$ERRORS" -gt 5 ]; then
        print_status info "Found $ERRORS log entries with 'error' (may include normal pipeline errors)"
    fi
    
    echo ""
    echo -e "  ${BOLD}Configuration:${NC}"
    echo "    • Input: UDP 2055 (NetFlow v5, v9)"
    echo "    • Filter: Internal network tagging"
    echo "    • Output: Elasticsearch data streams"
    
elif [ "$LOGSTASH_STATUS" = "created" ] || [ "$LOGSTASH_STATUS" = "exited" ]; then
    print_status error "Logstash not running"
    echo "      Fix: docker start clab-ospf-network-logstash"
else
    print_status info "Logstash not deployed"
fi

# ============================================
# OTEL COLLECTOR
# ============================================
print_section "OpenTelemetry Collector"

OTEL_STATUS=$(docker inspect clab-ospf-network-otel-collector --format='{{.State.Status}}' 2>/dev/null)
echo -e "  ${BOLD}Status:${NC} ${OTEL_STATUS:-Unknown}"

if [ "$OTEL_STATUS" = "running" ]; then
    print_status ok "OTEL collector operational"
    
    echo ""
    echo -e "  ${BOLD}Active Receivers:${NC}"
    
    SNMP_RECEIVERS=$(grep -c "snmp/csr" "$LAB_DIR/configs/otel/otel-collector.yml" 2>/dev/null || echo 0)
    echo "    • SNMP: $SNMP_RECEIVERS receivers"
    
    if grep -q "syslog:" "$LAB_DIR/configs/otel/otel-collector.yml" 2>/dev/null; then
        echo "    • Syslog: Enabled (UDP 5140)"
    fi
    
    echo ""
    echo -e "  ${BOLD}Collection Intervals:${NC}"
    echo "    • System/Interface: 10s"
    echo "    • Protocols (IP/TCP/UDP): 15s"
    echo "    • ARP: 30s"
    echo "    • Syslog: Real-time"
    
    ERRORS=$(docker logs --tail 100 clab-ospf-network-otel-collector 2>&1 | grep -ic "error" || echo 0)
    if [ "$ERRORS" -gt 10 ]; then
        print_status warning "Found $ERRORS errors in OTEL logs"
        echo "      Check: docker logs clab-ospf-network-otel-collector"
    fi
else
    print_status error "OTEL collector not running"
    echo "      Fix: docker restart clab-ospf-network-otel-collector"
fi

# ============================================
# ELASTICSEARCH
# ============================================
print_section "Elasticsearch Serverless"

if [ -n "$ES_ENDPOINT" ] && [ -n "$ES_API_KEY" ]; then
    echo -e "  ${BOLD}Endpoint:${NC} $ES_ENDPOINT"
    
    ES_VERSION=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT" 2>/dev/null | jq -r '.version.number // "unknown"')
    if [ "$ES_VERSION" != "unknown" ]; then
        echo "  Version: $ES_VERSION"
        print_status ok "Elasticsearch reachable"
    else
        print_status error "Elasticsearch connection failed"
    fi
    
    echo ""
    echo -e "  ${BOLD}Data Streams Summary:${NC}"
    echo "    • SNMP Metrics: ${SNMP_COUNT} docs (recent: ${SNMP_RECENT}/min)"
    echo "    • FRR Logs: ${LOGS_COUNT} docs (recent: ${LOGS_RECENT}/min)"
    echo "    • LLDP Topology: ${LLDP_COUNT} docs (recent: ${LLDP_RECENT}/min)"
    echo "    • NetFlow: ${NETFLOW_COUNT} docs (recent: ${NETFLOW_RECENT}/min)"
    
    echo ""
    TOTAL_DOCS=$((SNMP_COUNT + LOGS_COUNT + LLDP_COUNT + NETFLOW_COUNT))
    echo "  Total documents: ${TOTAL_DOCS}"
    
    if [ "$TOTAL_DOCS" -gt 1000 ]; then
        print_status ok "All data streams operational"
    elif [ "$TOTAL_DOCS" -gt 100 ]; then
        print_status ok "Data collection in progress"
    else
        print_status warning "Limited data in Elasticsearch"
    fi
    
else
    print_status warning "Elasticsearch not configured"
    echo "  Setup: ./scripts/configure-elasticsearch.sh"
fi

# ============================================
# BACKUP STATUS
# ============================================
print_section "Backup System"

if [ -d "$LAB_DIR/backups" ]; then
    BACKUP_COUNT=$(ls -1 "$LAB_DIR/backups" | grep -E "^[0-9]{8}_[0-9]{6}$" | wc -l)
    ARCHIVE_COUNT=$(ls -1 "$LAB_DIR/backups"/*.tar.gz 2>/dev/null | wc -l)
    
    echo "  Backups: $BACKUP_COUNT directories, $ARCHIVE_COUNT archives"
    
    if [ "$BACKUP_COUNT" -gt 0 ]; then
        LATEST=$(ls -1t "$LAB_DIR/backups" | grep -E "^[0-9]{8}_[0-9]{6}$" | head -1)
        LATEST_DATE=$(echo "$LATEST" | sed 's/_/ /')
        LATEST_SIZE=$(du -sh "$LAB_DIR/backups/$LATEST" 2>/dev/null | cut -f1)
        echo "  Latest: $LATEST_DATE ($LATEST_SIZE)"
        print_status ok "Backups available"
    else
        print_status info "No backups yet"
    fi
    
    if systemctl is-active --quiet ospf-lab-backup.timer 2>/dev/null; then
        NEXT_BACKUP=$(systemctl show ospf-lab-backup.timer -p NextElapseUSecRealtime 2>/dev/null | cut -d= -f2 | cut -d' ' -f1-3)
        echo "  Automated: Enabled (next: $NEXT_BACKUP)"
        print_status ok "Automated backups active"
    else
        print_status info "Automated backups not configured"
    fi
else
    print_status info "No backup directory"
fi

# ============================================
# HEALTH SCORE
# ============================================
print_section "System Health Summary"

HEALTH=0
MAX_HEALTH=100

# Infrastructure (15)
if [ "$RUNNING" -eq "$TOTAL" ]; then
    HEALTH=$((HEALTH + 15))
elif [ "$RUNNING" -ge $((TOTAL - 1)) ]; then
    HEALTH=$((HEALTH + 10))
else
    HEALTH=$((HEALTH + 5))
fi

# Routing (15)
if [ "$OSPF_FULL" -ge 2 ]; then
    HEALTH=$((HEALTH + 15))
else
    HEALTH=$((HEALTH + 5))
fi

# LLDP (15) - based on data
if [ "${LLDP_COUNT:-0}" -gt 100 ]; then
    HEALTH=$((HEALTH + 15))
elif [ "${LLDP_COUNT:-0}" -gt 0 ]; then
    HEALTH=$((HEALTH + 7))
fi

# SNMP (15) - based on data
if [ "${SNMP_COUNT:-0}" -gt 1000 ]; then
    HEALTH=$((HEALTH + 15))
elif [ "${SNMP_COUNT:-0}" -gt 0 ]; then
    HEALTH=$((HEALTH + 7))
fi

# Syslog (10) - based on data
if [ "${LOGS_COUNT:-0}" -gt 10 ]; then
    HEALTH=$((HEALTH + 10))
elif [ "${LOGS_COUNT:-0}" -gt 0 ]; then
    HEALTH=$((HEALTH + 5))
fi

# OTEL (10)
if [ "$OTEL_STATUS" = "running" ]; then
    HEALTH=$((HEALTH + 10))
fi

# Logstash (10)
if [ "$LOGSTASH_STATUS" = "running" ]; then
    HEALTH=$((HEALTH + 10))
fi

# Elasticsearch (10)
if [ "$TOTAL_DOCS" -gt 1000 ]; then
    HEALTH=$((HEALTH + 10))
elif [ "$TOTAL_DOCS" -gt 0 ]; then
    HEALTH=$((HEALTH + 5))
fi

# Cap health at 100
if [ "$HEALTH" -gt "$MAX_HEALTH" ]; then
    HEALTH=$MAX_HEALTH
fi

echo ""
echo -e "  ${BOLD}Overall Health Score: $HEALTH/$MAX_HEALTH${NC}"
echo ""
echo -n "  ["
for i in $(seq 1 10); do
    if [ $((i * 10)) -le $HEALTH ]; then
        echo -n -e "${GREEN}█${NC}"
    else
        echo -n "░"
    fi
done
echo "]"
echo ""

if [ "$HEALTH" -ge 90 ]; then
    print_status ok "System operating at peak performance"
elif [ "$HEALTH" -ge 70 ]; then
    print_status ok "System operational with minor issues"
elif [ "$HEALTH" -ge 50 ]; then
    print_status warning "System operational but needs attention"
else
    print_status error "System has significant issues"
fi

# ============================================
# QUICK COMMANDS
# ============================================
print_header "Quick Commands"

echo -e "${BOLD}Management:${NC}"
echo "  ./connect.sh                          - Interactive menu"
echo "  ./scripts/show-topology.sh            - Network topology"
echo ""
echo -e "${BOLD}Monitoring:${NC}"
echo "  docker logs -f clab-ospf-network-otel-collector"
echo "  docker logs -f clab-ospf-network-logstash"
echo ""
echo -e "${BOLD}NetFlow:${NC}"
echo "  ./scripts/setup-netflow.sh            - Setup NetFlow"
echo "  ./scripts/generate-traffic.sh         - Generate traffic"
echo ""

print_header "End of Status Report"
