#!/bin/bash

echo "========================================="
echo "Complete OSPF OTEL Lab Setup v13.0"
echo "  STATIC IPs (172.20.20.23-29)"
echo "  FAST MODE - 10s/15s/30s intervals"
echo "  ALL METRICS + LLDP + NETFLOW"
echo "  Elasticsearch Serverless"
echo "Estimated time: 12-15 minutes"
echo "========================================="

cd ~/ospf-otel-lab

# Step 0: Check Elasticsearch configuration
if [ ! -f .env ]; then
    echo ""
    echo "✗ Elasticsearch not configured"
    echo ""
    echo "Run: ./scripts/configure-elasticsearch.sh"
    exit 1
fi

source .env

if [ -z "$ES_ENDPOINT" ] || [ -z "$ES_API_KEY" ]; then
    echo ""
    echo "✗ Elasticsearch configuration incomplete"
    echo ""
    echo "Run: ./scripts/configure-elasticsearch.sh"
    exit 1
fi

echo ""
echo "✓ Using Elasticsearch: $ES_ENDPOINT"

# Step 0.5: Ensure topology has static IPs
echo ""
echo "Step 0: Ensuring topology has static IP assignments..."

if ! grep -q "mgmt-ipv4: 172.20.20.23" ospf-network.clab.yml; then
    echo "  Adding static IPs to topology..."
    
    # Backup
    cp ospf-network.clab.yml ospf-network.clab.yml.backup-$(date +%s)
    
    # Add static IPs using Python
    cat > /tmp/fix_ips.py << 'PYTHON'
import yaml

with open('ospf-network.clab.yml', 'r') as f:
    config = yaml.safe_load(f)

routers = {
    'csr23': '172.20.20.23',
    'csr24': '172.20.20.24',
    'csr25': '172.20.20.25',
    'csr26': '172.20.20.26',
    'csr27': '172.20.20.27',
    'csr28': '172.20.20.28',
    'csr29': '172.20.20.29'
}

for router, ip in routers.items():
    if router in config['topology']['nodes']:
        config['topology']['nodes'][router]['mgmt-ipv4'] = ip

with open('ospf-network.clab.yml', 'w') as f:
    yaml.dump(config, f, default_flow_style=False, sort_keys=False)
PYTHON

    python3 /tmp/fix_ips.py
    echo "  ✓ Static IPs added to topology"
else
    echo "  ✓ Topology already has static IPs"
fi

# Cleanup if exists
if sudo clab inspect -t ospf-network.clab.yml &>/dev/null 2>&1; then
    echo ""
    echo "Existing lab found. Cleaning up..."
    sudo clab destroy -t ospf-network.clab.yml --cleanup 2>/dev/null || true
    sleep 10
fi

# Deploy with static IPs
echo ""
echo "Step 1/11: Deploying containerlab topology with static IPs..."
sudo clab deploy -t ospf-network.clab.yml

if [ $? -ne 0 ]; then
    echo ""
    echo "✗ Deployment failed. Check errors above."
    exit 1
fi

# Verify static IPs
echo ""
echo "Verifying static IP assignments..."
ALL_CORRECT=true
for i in 23 24 25 26 27 28 29; do
    IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' clab-ospf-network-csr$i 2>/dev/null)
    if [ "$IP" = "172.20.20.$i" ]; then
        echo "  ✓ csr$i = $IP"
    else
        echo "  ✗ csr$i = $IP (expected 172.20.20.$i)"
        ALL_CORRECT=false
    fi
done

if [ "$ALL_CORRECT" = false ]; then
    echo ""
    echo "⚠ Warning: Static IPs not applied correctly"
    echo "  Continuing with dynamic IPs..."
fi

# Wait for initialization
echo ""
echo "Step 2/11: Waiting 60 seconds for initialization..."
sleep 60

# Install SNMP + LLDP
echo ""
echo "Step 3/11: Installing SNMP + LLDP on all routers..."
./scripts/install-snmp-direct.sh <<< "y"

# Create COMPLETE FAST MODE OTEL config
echo ""
echo "Step 4/11: Creating COMPLETE OTEL configuration with correct IPs..."
./scripts/create-otel-config-fast-mode.sh

# Update OTEL config with actual IPs
echo ""
echo "Step 5/11: Updating OTEL config with actual router IPs..."
for i in 23 24 25 26 27 28 29; do
    ACTUAL_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' clab-ospf-network-csr$i)
    
    # Update both possible formats
    sed -i "s|endpoint: udp://[0-9.]*:161 # csr$i|endpoint: udp://$ACTUAL_IP:161 # csr$i|g" configs/otel/otel-config.yaml
    sed -i "s|endpoint: udp://172.20.20.[0-9]*:161.*csr$i|endpoint: udp://$ACTUAL_IP:161 # csr$i|g" configs/otel/otel-config.yaml
    
    echo "  csr$i: $ACTUAL_IP"
done

echo "✓ OTEL config updated with actual IPs"

# Restart OTEL
echo ""
echo "Step 6/11: Restarting OTEL Collector with updated config..."
docker restart clab-ospf-network-otel-collector
sleep 30

# Check OTEL started successfully
OTEL_STATUS=$(docker inspect clab-ospf-network-otel-collector --format='{{.State.Status}}' 2>/dev/null)
if [ "$OTEL_STATUS" != "running" ]; then
    echo "✗ OTEL failed to start. Checking logs:"
    docker logs --tail 30 clab-ospf-network-otel-collector
    exit 1
fi

echo "✓ OTEL Collector running with ALL METRICS"

# Wait for OSPF convergence
echo ""
echo "Step 7/11: Waiting 30 seconds for OSPF convergence..."
sleep 30

# Setup LLDP export service
echo ""
echo "Step 8/11: Setting up LLDP export service..."
./scripts/setup-lldp-service.sh

# Deploy NetFlow collection
echo ""
echo "Step 9/11: Deploying NetFlow collection (softflowd)..."
if [ -f ./scripts/deploy-softflowd.sh ]; then
    ./scripts/deploy-softflowd.sh
    echo "✓ NetFlow collection deployed"
else
    echo "⚠ NetFlow deployment script not found, skipping..."
fi

# Restart Logstash to ensure it's listening
echo ""
echo "Step 10/11: Ensuring Logstash is ready for NetFlow..."
docker restart clab-ospf-network-logstash 2>/dev/null || echo "  Logstash not found, skipping..."
sleep 20

# Verify Logstash is listening
LOGSTASH_LISTENING=$(docker exec clab-ospf-network-logstash netstat -uln 2>/dev/null | grep -c 2055)
if [ "$LOGSTASH_LISTENING" -gt 0 ]; then
    echo "✓ Logstash listening on UDP 2055 for NetFlow"
else
    echo "⚠ Logstash not listening on UDP 2055 (NetFlow won't work)"
fi

# Wait for metrics collection
echo ""
echo "Step 11/11: Waiting 60 seconds for telemetry collection..."
sleep 60

# Verify
echo ""
echo "========================================="
echo "Verifying deployment..."
echo "========================================="
echo ""

# Check SNMP connectivity
echo "SNMP Status:"
SNMP_ERRORS=$(docker logs --tail 100 clab-ospf-network-otel-collector 2>&1 | grep -c "connection refused")
if [ "$SNMP_ERRORS" -eq 0 ]; then
    echo "  ✓ No SNMP connection errors"
else
    echo "  ⚠ $SNMP_ERRORS SNMP connection errors detected"
fi

# Check Elasticsearch
echo ""
echo "Elasticsearch Status:"
DOC_COUNT=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/metrics-*/_count" 2>/dev/null | jq -r '.count // 0')
echo "  SNMP metrics documents: ${DOC_COUNT:-0}"

LLDP_COUNT=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/lldp-topology/_count" 2>/dev/null | jq -r '.count // 0')
echo "  LLDP topology documents: ${LLDP_COUNT:-0}"

NETFLOW_COUNT=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/logs-netflow*/_count" 2>/dev/null | jq -r '.count // 0')
echo "  NetFlow documents: ${NETFLOW_COUNT:-0}"

if [ "${DOC_COUNT:-0}" -gt 0 ]; then
    echo "  ✓ SNMP metrics are flowing in FAST MODE!"
    
    # Count metric types
    METRIC_TYPES=$(curl -s -H "Authorization: ApiKey $ES_API_KEY" "$ES_ENDPOINT/metrics-*/_search?size=0" -H 'Content-Type: application/json' -d '{
      "aggs": {
        "metric_types": {
          "cardinality": {"field": "metric.name.keyword"}
        }
      }
    }' 2>/dev/null | jq -r '.aggregations.metric_types.value // 0')
    echo "  Unique metric types: ${METRIC_TYPES:-0}"
else
    echo "  ⚠ No SNMP metrics yet. Wait 1-2 more minutes."
fi

if [ "${LLDP_COUNT:-0}" -gt 0 ]; then
    echo "  ✓ LLDP topology data is flowing!"
else
    echo "  ⚠ No LLDP data yet. Check: sudo systemctl status lldp-export"
fi

if [ "${NETFLOW_COUNT:-0}" -gt 0 ]; then
    echo "  ✓ NetFlow data is flowing!"
else
    echo "  ⚠ No NetFlow data yet. Wait 2-3 minutes for flow exports."
fi

# Check softflowd processes
echo ""
echo "NetFlow Export Status:"
SOFTFLOWD_COUNT=$(docker exec clab-ospf-network-csr23 ps 2>/dev/null | grep -c softflowd || echo "0")
if [ "$SOFTFLOWD_COUNT" -gt 0 ]; then
    echo "  ✓ Softflowd running on routers ($SOFTFLOWD_COUNT processes on csr23)"
else
    echo "  ⚠ Softflowd not running"
fi

# Final status
echo ""
echo "========================================="
echo "   COMPLETE SETUP FINISHED - v13.0!"
echo "========================================="
echo ""
./scripts/status.sh

echo ""
echo "Next Steps:"
echo "  Interactive menu:     ./scripts/connect.sh"
echo "  Emergency diagnostic: ./scripts/emergency-diagnostic.sh"
echo "  Show topology:        ./scripts/show-topology.sh"
echo "  LLDP status:          ./scripts/lldp-status.sh"
echo "  LLDP neighbors:       ./scripts/show-lldp-neighbors.sh"
echo "  List all metrics:     ./scripts/list-all-metrics.sh"
echo "  NetFlow status:       docker logs --tail 50 clab-ospf-network-logstash"
echo ""
echo "Check NetFlow dashboards in Kibana after 2-3 minutes!"
echo ""
