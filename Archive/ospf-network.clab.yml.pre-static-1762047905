name: ospf-network

mgmt:
  network: clab
  ipv4-subnet: 172.20.20.0/24
  ipv6-subnet: 3fff:172:20:20::/64

topology:
  nodes:
    # ============================================
    # ROUTERS (7 FRR Routers)
    # ============================================
    
    csr28:
      kind: linux
      image: frrouting/frr:v8.4.0
      binds:
        - configs/routers/csr28/daemons:/etc/frr/daemons:ro
        - configs/routers/csr28/frr.conf:/etc/frr/frr.conf:ro
      exec:
        - ip link set eth1 up
        - ip link set eth2 up
        - ip link set eth3 up
        - ip addr add 10.0.1.1/31 dev eth1
        - ip addr add 10.0.2.1/31 dev eth2
        - ip addr add 192.168.20.1/24 dev eth3
        - touch /etc/frr/vtysh.conf
        - /usr/lib/frr/frrinit.sh start
    
    csr24:
      kind: linux
      image: frrouting/frr:v8.4.0
      binds:
        - configs/routers/csr24/daemons:/etc/frr/daemons:ro
        - configs/routers/csr24/frr.conf:/etc/frr/frr.conf:ro
      exec:
        - ip link set eth1 up
        - ip link set eth2 up
        - ip link set eth3 up
        - ip link set eth4 up
        - ip link set eth5 up
        - ip addr add 10.0.1.0/31 dev eth1
        - ip addr add 10.0.9.0/31 dev eth2
        - ip addr add 10.0.3.1/31 dev eth3
        - ip addr add 10.0.4.0/31 dev eth4
        - ip addr add 10.0.6.0/31 dev eth5
        - touch /etc/frr/vtysh.conf
        - /usr/lib/frr/frrinit.sh start
    
    csr23:
      kind: linux
      image: frrouting/frr:v8.4.0
      binds:
        - configs/routers/csr23/daemons:/etc/frr/daemons:ro
        - configs/routers/csr23/frr.conf:/etc/frr/frr.conf:ro
      exec:
        - ip link set eth1 up
        - ip link set eth2 up
        - ip link set eth3 up
        - ip link set eth4 up
        - ip link set eth5 up
        - ip addr add 10.0.7.0/31 dev eth1
        - ip addr add 10.0.2.0/31 dev eth2
        - ip addr add 10.0.3.0/31 dev eth3
        - ip addr add 10.0.5.0/31 dev eth4
        - ip addr add 10.0.11.0/31 dev eth5
        - touch /etc/frr/vtysh.conf
        - /usr/lib/frr/frrinit.sh start
    
    csr29:
      kind: linux
      image: frrouting/frr:v8.4.0
      binds:
        - configs/routers/csr29/daemons:/etc/frr/daemons:ro
        - configs/routers/csr29/frr.conf:/etc/frr/frr.conf:ro
      exec:
        - ip link set eth1 up
        - ip link set eth2 up
        - ip addr add 10.0.9.1/31 dev eth1
        - ip addr add 10.0.10.1/31 dev eth2
        - touch /etc/frr/vtysh.conf
        - /usr/lib/frr/frrinit.sh start
    
    csr27:
      kind: linux
      image: frrouting/frr:v8.4.0
      binds:
        - configs/routers/csr27/daemons:/etc/frr/daemons:ro
        - configs/routers/csr27/frr.conf:/etc/frr/frr.conf:ro
      exec:
        - ip link set eth1 up
        - ip link set eth2 up
        - ip addr add 10.0.11.1/31 dev eth1
        - ip addr add 10.0.12.1/31 dev eth2
        - touch /etc/frr/vtysh.conf
        - /usr/lib/frr/frrinit.sh start
    
    csr26:
      kind: linux
      image: frrouting/frr:v8.4.0
      binds:
        - configs/routers/csr26/daemons:/etc/frr/daemons:ro
        - configs/routers/csr26/frr.conf:/etc/frr/frr.conf:ro
      exec:
        - ip link set eth1 up
        - ip link set eth2 up
        - ip link set eth3 up
        - ip link set eth4 up
        - ip link set eth5 up
        - ip addr add 10.0.10.0/31 dev eth1
        - ip addr add 10.0.7.1/31 dev eth2
        - ip addr add 10.0.4.1/31 dev eth3
        - ip addr add 10.0.8.1/31 dev eth4
        - ip addr add 192.168.10.3/24 dev eth5
        - touch /etc/frr/vtysh.conf
        - /usr/lib/frr/frrinit.sh start
    
    csr25:
      kind: linux
      image: frrouting/frr:v8.4.0
      binds:
        - configs/routers/csr25/daemons:/etc/frr/daemons:ro
        - configs/routers/csr25/frr.conf:/etc/frr/frr.conf:ro
      exec:
        - ip link set eth1 up
        - ip link set eth2 up
        - ip link set eth3 up
        - ip link set eth4 up
        - ip link set eth5 up
        - ip addr add 10.0.5.1/31 dev eth1
        - ip addr add 10.0.6.1/31 dev eth2
        - ip addr add 10.0.8.0/31 dev eth3
        - ip addr add 10.0.12.0/31 dev eth4
        - ip addr add 192.168.10.2/24 dev eth5
        - touch /etc/frr/vtysh.conf
        - /usr/lib/frr/frrinit.sh start
    
    # ============================================
    # SWITCHES
    # ============================================
    
    sw:
      kind: linux
      image: alpine:latest
      exec:
        - ip link add br0 type bridge
        - ip link set br0 up
        - ip link set eth1 master br0 && ip link set eth1 up
        - ip link set eth2 master br0 && ip link set eth2 up
        - ip link set eth3 master br0 && ip link set eth3 up
    
    sw2:
      kind: linux
      image: alpine:latest
      exec:
        - ip link add br0 type bridge
        - ip link set br0 up
        - ip link set eth1 master br0 && ip link set eth1 up
        - ip link set eth2 master br0 && ip link set eth2 up
    
    # ============================================
    # END DEVICES
    # ============================================
    
    win-bottom:
      kind: linux
      image: alpine:latest
      exec:
        - ip addr add 192.168.10.10/24 dev eth1
        - ip link set eth1 up
        - ip route add default via 192.168.10.1
    
    linux-bottom:
      kind: linux
      image: alpine:latest
      binds:
        - scripts:/scripts
        - logs:/var/log
      exec:
        - ip addr add 192.168.10.20/24 dev eth1
        - ip link set eth1 up
        - ip route add default via 192.168.10.1
        - apk add --no-cache bash curl jq
    
    node1:
      kind: linux
      image: alpine:latest
      exec:
        - ip addr add 192.168.20.100/24 dev eth1
        - ip link set eth1 up
        - ip route add default via 192.168.20.1
    
    # ============================================
    # TELEMETRY STACK
    # ============================================
    
    otel-collector:
      kind: linux
      image: otel/opentelemetry-collector-contrib:latest
      binds:
        - configs/otel/otel-collector.yml:/etc/otelcol-contrib/config.yaml:ro
        - .env:/etc/otelcol-contrib/.env:ro
      cmd: --config=/etc/otelcol-contrib/config.yaml
      ports:
        - "8888:8888"
        - "4317:4317"
        - "5140:5140/udp"  # ⬅️ ADD THIS LINE FOR SYSLOG

    # ============================================
    # LOGSTASH FOR NETFLOW
    # ============================================
    logstash:
      kind: linux
      image: docker.elastic.co/logstash/logstash:9.2.0
      binds:
        - configs/logstash/pipeline:/usr/share/logstash/pipeline:ro
        - configs/logstash/logstash.yml:/usr/share/logstash/config/logstash.yml:ro
      env:
        LS_JAVA_OPTS: "-Xmx512m -Xms512m"

  links:
    # CSR28 connections
    - endpoints: ["csr28:eth1", "csr24:eth1"]
    - endpoints: ["csr28:eth2", "csr23:eth2"]
    - endpoints: ["csr28:eth3", "sw2:eth1"]
    
    # CSR24 connections
    - endpoints: ["csr24:eth2", "csr29:eth1"]
    - endpoints: ["csr24:eth3", "csr23:eth3"]
    - endpoints: ["csr24:eth4", "csr26:eth3"]
    - endpoints: ["csr24:eth5", "csr25:eth2"]
    
    # CSR23 connections
    - endpoints: ["csr23:eth1", "csr26:eth2"]
    - endpoints: ["csr23:eth4", "csr25:eth1"]
    - endpoints: ["csr23:eth5", "csr27:eth1"]
    
    # CSR29 connection
    - endpoints: ["csr29:eth2", "csr26:eth1"]
    
    # CSR27 connection
    - endpoints: ["csr27:eth2", "csr25:eth4"]
    
    # VRRP pair link
    - endpoints: ["csr26:eth4", "csr25:eth3"]
    
    # Switch connections
    - endpoints: ["csr25:eth5", "sw:eth1"]
    - endpoints: ["csr26:eth5", "sw:eth2"]
    
    # End devices
    - endpoints: ["sw:eth3", "win-bottom:eth1"]
    - endpoints: ["sw2:eth2", "node1:eth1"]
